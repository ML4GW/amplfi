# AMPLFI
**Accelerated Multi-messenger Parameter estimation with Likelihood Free Inference**

Framework for performing rapid parameter estimation of gravitational wave events using likelihood free inference

## Environment Setup
> **_Note: this repository is a WIP. Please open up an issue if you encounter bugs, quirks, or any undesired behavior_**

> **_Note: Running AMPLFI out-of-the-box requires access to an enterprise-grade GPU(s) (e.g. P100, V100, T4, A[30,40,100], etc.). There are several nodes on the LIGO Data Grid which meet these requirements_**.

Please see the [ml4gw quickstart](https://github.com/ml4gw/quickstart/) for help on setting up your environment 
on the [LIGO Data Grid](https://computing.docs.ligo.org/guide/computing-centres/ldg/) (LDG) and for configuring access to [Weights and Biases](https://wandb.ai), and the [Nautilus hypercluster](https://ucsd-prp.gitlab.io/). 
This quickstart includes a Makefile and instructions for setting up all of the necessary software, environment variables, and credentials required to run `AMPLFI`. 

Once setup, create a [fork](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/fork-a-repo) of this repository, and clone it.

> **_Note: Ensure that you have added a [github ssh key](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account) to your account_**

```bash
git clone git@github.com:albert-einstein/amplfi.git
```

`AMPLFI` utilizes `git` [submodules](https://git-scm.com/book/en/v2/Git-Tools-Submodules). Make sure to initialize and update those

```bash
git submodule update --init
```

When pulling changes from this repository, it's recommended to use the `--recurse-submodules` flag to pull any updates from the submodules as well.

Next, install the `amplfi.law` submodule, which is used for launching `amplfi` data generation workflows with [`law`](https://github.com/riga/law)

```console
cd amplfi/law
poetry install
```

## Building Containers
Some `AMPLFI` workflows can be run via `apptainer` images.
To build the containers, first set the `$AMPLFI_CONTAINER_ROOT` environment variable
to a location where you want the images to be stored, e.g. `~/amplfi/images`. It is recommended to also add this 
environment variable to your `~/.bash_profile` (or your shells equivalent).

To build the `train` and `data` containers, make sure you are in the respective projects home directory. For example, starting from the 
`amplfi` repositories home directory the `data` image can be built by running the following"

```console
cd projects/data
apptainer build $AMPLFI_CONTAINER_ROOT/data.sif apptainer.def
```

Make sure you do the same for the `train` image!


## Initializing a Pipeline
`AMPLFI` comes with a handy command, `amplfi-init`, for initializing a run directory:

```console
> poetry run amplfi-init --help

usage: amplfi-init [-h] [--mode {flow,similarity}] [--pipeline {tune,train}] [-d DIRECTORY] [--s3-bucket S3_BUCKET]

Initialize a directory with configuration files for running end-to-end amplfi training or tuning pipelines

optional arguments:
  -h, --help            Show this help message and exit.
  --mode {flow,similarity}
                        Either 'flow' or 'similarity',Whether to setup a flow or similarity training (default: flow)
  --pipeline {tune,train}
                        Either 'train' or 'tune'.Whether to setup a tune or train pipeline (default: train)
  -d DIRECTORY, --directory DIRECTORY
                        The run directory where theconfiguration files will be copied to (required, type: <class 'Path'>)
  --s3-bucket S3_BUCKET
                        (default: null)
```

For example, the following will initialize a run directory at `~/amplfi/flow-run` to train a flow

```console
poetry run amplfi-init --mode flow --pipeline train --directory ~/amplfi/flow-run
```

A `run.sh` will be created in the run directory that launches data generation via `law` followed by the training job.
Alongside, a `datagen.cfg` and `.yaml` file will be copied that configure the datageneration and training respectively. 


## Testing
Sample corner plots and probability-probability plots (PP-plots) can be generated by running the `test` subcommand. 
Remember to pass your trained model weights, which can be found at the $AMPLFI_OUTDIR directory. In this case,
we pass the weights corresponding to the best validation score, which are automatically saved at `$AMPLFI_OUTDIR/train_logs/best.ckpt`

```console
APPTAINERENV_AMPLFI_OUTDIR=$AMPLFI_OUTDIR APPTAINERENV_AMPLFI_DATADIR=$AMPLFI_DATADIR \
    apptainer run --nv $AMPLFI_CONTAINER_ROOT/train.sif python /opt/amplfi/projects/train/train/cli/flow.py test \
    --config /path/to/config.yaml --model.checkpoint=$AMPLFI_OUTDIR/train_logs/best.ckpt
```
